# Chapter 13 : 교착 상태

## 교착 상태란

- 도로 위에서 차가 막혀 꼼짝도 못하고 마비된 상황이 종종 일어난다.
- 프로세스도 마찬가지인데, 두 개 이상의 프로세스가 각자 가지고 있는 자원을 무작정 기다린다면 그 어떤 프로세스도 더 이상 진행할 수 없는 **교착 상태**가 된다.

### 식사하는 철학자 문제

- **식사하는 철학자 문제**는 교착 상태를 설명하기 위한 고전적이고 재밌는 문제 상황이다.
- 왜 교착 상태가 발생하는지, 나아가 교착 상태를 어떻게 해결하는지 알려준다.
- 다섯 명의 철학자가 동그란 식탁에 앉아 식사를 먹으려고 하는데, 포크가 두 개 필요한 상황에서 식사 가운데에 포크가 하나씩 다섯개가 있다면, 철학자들은 하나의 포크를 들 수는 있지만 다음 포크를 무한정 기다리게 되므로 누구도 식사를 할 수 없게 된다.
- 이렇게 일어나지 않을 사건을 기다리며 진행이 멈춰 버리는 현상을 **교착 상태**(**Deadlock**)이라고 한다.
- 위 문제에서 철학자는 프로세스 혹은 스레드, 포크는 자원, 생각하는 행위는 자원을 기다리는 것에 빗대어 볼 수 있으며 포크는 한 번에 하나의 프로세스 혹은 스레드만 접근할 수 있으니 임계 구역이라고 볼 수 있다.
- 게임 프로세스가 자원 A를, 웹 프로세스가 자원 B를 점유한 상태에서 게임 프로세스가 자원 B를, 웹 프로세스가 자원 A를 기다리게 된다면 둘은 상대방이 가진 자원을 무한정 기다리다가 결국 실행을 못 하게 되는데, 이가 교착 상태이다.
- 이러한 교착 상태를 해결하기 위해선 교착 상태가 발생했을 때의 상황을 정확히 표현해보고, 교착 상태가 일어나는 근본적인 이유에 대해 알아야 한다.

### 자원 할당 그래프

- 교착 상태는 **자원 할당 그래프**를 통해 단순히 표현 가능하다.
- 자원 할당 그래프는 어떤 프로세스가 어떤 자원을 사용하며 어떤 자원을 기다리는지 표현하는 간단한 그래프이다.
- 자원 할당 그래프는 아래와 같은 규칙으로 그려진다.
  1. 프로세스는 원으로, 자원의 종류는 사각형으로 표현한다.
  2. 사용할 수 있는 자원의 개수는 자원 사각형 내에 점으로 표현한다.
    - 같은 자원이어도 사용 가능한 자원의 개수는 여러 개 있을 수 있다.
    - 예를 들어, 하드 디스크가 세 개인 컴퓨터는 종류는 하드 디스크 하나지만, 사용 가능한 하드 디스크 개수는 세 개이다.
  3. 프로세스가 어떤 자원을 할당받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시한다.
  4. 프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표를 표시한다.
- 식사하는 철학자 문제나 프로세스 두 개가 서로를 기다리고 있는 경우를 자원 할당 그래프로 그려보면 원의 형태를 띄고 있음을 알 수 있다.

### 교착 상태 발생 조건

- 교착 상태 발생 조건에는 네 가지가 있다. 아래의 조건이 모두 만족될 때 교착 상태가 발생할 가능성이 생긴다.
  1. **상호 배제**(Mutual Exclusion)
  2. **점유와 대기**(Hold and Wait)
  3. **비선점**(Nonpreemptive)
  4. **원형 대기**(Circular Wait)
- **상호 배제**
  - 교착 상태가 발생한 근본적인 원인은, 해당 자원을 한 번에 하나의 프로세스만 이용 가능했기 때문이다.
  - 식사하는 철학자 문제에서 하나의 포크를 여러 명이 동시에 사용할 수 있었다면, 교착 상태는 발생하지 않았을 것이다.
  - 즉 프로세스도 마찬가지로 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없을 때, 즉 상호 배제 상황에서 교착 상태가 발생할 수 있다.
- **점유와 대기**
  - 식사하는 철학자 문제에서 누구도 식사를 할 수 없던 이유는 '왼쪽 포크를 든 채' 다른 포크를 기다렸기 때문이다.
  - 자원을 보유한 채 다른 자원을 기다리면 문제가 발생할 수 있다.
  - 이렇게 자원을 할당받은 상태에서 다른 자원을 기다리는 상태를 점유와 대기라고 한다.
- **비선점**
  - 만일 철학자들 중 다른 철학자의 포크를 강제로 빼앗을 수 있었다면 교착 상태는 발생하지 않았을 것이다.
  - 이처럼 근본적인 문제는 프로세스가 자원을 비선점하고 있었기 때문이다.
  - 비선점 자원은 그 자원을 이용하는 프로세스의 작업이 끝나야만 비로소 이용할 수 있다.
  - 자원을 강제로 빼앗을 수 있었다면 교착 상태가 발생하지 않을 것이다.
- **원형 대기**
  - 프로세스들과 프로세스가 요청 및 할당받은 자원이 원의 형태를 이루었기 때문에 교착 상태가 발생했다.
  - 자원 할당 그래프가 원의 형태로 그려지면 교착 상태가 발생할 수 있다.
  - 이런 원의 형태로 자원을 대기하는 것을 원형 대기라고 한다.

## 교착 상태 해결 방법

- 교착 상태를 해결하는 데엔 크게 예방, 회피, 검출 후 회복이 있다.

### 교착 상태 예방

- 교착 상태 예방은 교착 상태 발생 필요 조건 네 가지중 한 가지를 충족하지 못 하게 하는 방법이다.
- 자원의 **상호 배제를 없애는 방법**
  - 이 말의 의미는 모든 자원을 공유 가능하게 만든다는 말과 같다.
  - 그러나 현실적으로 모든 자원의 상호 배제를 없애는 것이 불가능에 가까워 다소 무리가 있다.
- **점유와 대기를 없애는 방법**
  - 이는 식사하는 철학자 문제에서 한 손에 포크를 들고 다른 포크를 기다리지 못하게 하는 것이다.
  - 포크를 두 개 동시에 들게 하거나, 아예 들지 못 하게 하는 것과 같다.
  - 이 방식도 이론적으로는 교착 상태를 해결할 수 있으나 단점도 있다.
    - 자원의 활용율이 낮아질 우려가 있다. 한 프로세스에 필요한 자원을 몰아주고, 다음에 다른 프로세스에 자원을 몰아주는 방식이 될 것이다. 오랫동안 할당되는 자원을 다수 양산하기에 비효율적이다.
    - 많은 자원을 사용하는 프로세스가 불리해진다. 자원을 적게 사용하는 프로세스에 비해 동시에 자원을 확보할 타이밍이 매우 어렵다. 결국 무한정 기다리게 되는 기아 현상이 발생할 수 있다.
- **비선점 조건을 없애는 방법**
  - 비선점 조건을 없애면 자원을 이용 중인 프로세스로부터 해당 자원을 빼앗을 수 있다.
  - 이 방식은 선점하여 사용할 수 있는 일부 자원에 대해서는 효과적이다.
  - 가령 CPU는 프로세스들이 선점할 수 있는 대표적인 자원이며, 한 프로세스가 CPU를 이용하다가 잠시 다른 프로세스에게 CPU를 할당하는 것이 가능하다.
  - 하지만 모든 자원이 이렇게 선점 가능한 것은 아니어서, 다소 범용성이 떨어지는 방안이다.
- **원형 대기 조건을 없애는 방법**
  - 이 방법은 간단하다, 모든 자원에 번호를 붙이고, 오름차순으로 자원을 할당하면 원형 대기는 발생하지 않는다.
  - 모든 포크에 1번부터 5번까지 번호를 붙이고 낮은 포크에서 높은 포크 순으로 집어들게 한다면, 5번 포크를 든 채 1번 포크를 집을 수 없게 된다.
  - 이는 원형 식탁에서 일자형 식탁으로 바꾼 것과 유사하다.
  - 이 방법은 앞선 세 가지 방법들에 비해 비교적 현실적이나 역시 단점은 있다.
    - 컴퓨터에 존재하는 수많은 자원에 일일이 번호를 붙이는 것은 간단한 작업이 아니다.
    - 각 자원에 어떤 번호를 붙이는지에 따라 특정 자원의 활용률이 떨어질 수 있다.
- 이렇듯 교착 상태 발생 조건을 원천적으로 제거하여 예방하는 것은, 교착 상태가 발생하지 않음을 보장할 수는 있으나 그에 따른 부작용들이 존재하게 된다.