# Chapter 08 : 입출력장치

## 장치 컨트롤러와 장치 드라이버

### 장치 컨트롤러

- 입출력장치엔 종류가 너무나도 많아 CPU나 메모리보다 다루기가 더 까다롭다.
- 이렇게 다양하면 자연스레 장치마다 속도, 데이터 전송 형식 등이 매우 다양해 규격화가 어렵다.
- 일반적으로 CPU와 메모리의 데이터 전송률은 높지만, 입출력장치의 데이터 전송률은 낮아 통신이 어렵다.
- 위와 같은 이유로, 입출력장치는 컴퓨터에 직접 연결되지 않고 **장치 컨트롤러**라는 하드웨어를 통해 연결한다.
  - 장치 컨트롤러는 **입출력 제어기**, **입출력 모듈** 등으로 다양히 불린다.
- 장치 컨트롤러는 하드웨어에 붙어있으며, 하나 이상의 입출력장치와 연결되어 있다.
- 장치 컨트롤러는 대표적으로 아래와 같은 문제를 해결한다.
  - CPU와 입출력장치 간의 통신 중개
  - 오류 검출
  - 데이터 버퍼링
- 장치 컨트롤러가 일종의 번역가 역할을 하여 오류 또한 검출해낼 수 있다.
- **버퍼링**이란 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를, **버퍼**라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법이다.
- 즉, 버퍼에 데이터를 조금씩 모았다가 한꺼번에 내보내는 방법이다.
- 장치 컨트롤러의 내부에는 데이터 레지스터, 상태 레지스터, 제어 레지스터가 존재한다.
  - **데이터 레지스터**는 CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터이다. 즉, 버퍼 역할이다.
  - **상태 레지스터**는 입출력장치가 작업을 할 준비가 되어는지, 완료되었는지, 오류는 없는지 등의 상태 정보를 저장하는 레지스터이다.
  - **제어 레지스터**는 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장한다.

### 장치 드라이버

- **장치 드라이버**란 장치 컨트롤러의 동작을 감지하고, 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램이다.
- 장치 컨트롤러가 입출력장치를 연결하기 위한 하드웨어적 통로이고, 장치 드라이버가 입출력장치를 연결하기 위한 소프트웨어적 통로이다.

## 다양한 입출력 방법

### 프로그램 입출력

- 프로그램 입출력은 기본적으로 프로그램 속 명령어로 입출력장치를 제어하는 방법이다.
- CPU가 프로그램 속 입출력 명령어를 만나면, CPU가 입출력 장치에 연결된 장치 컨트롤러와 상호작용한다.
- CPU가 입출력장치에 명령을 내릴 때, 입출력장치에 있는 장치 컨트롤러의 레지스터에 접근을 하게 되는데, CPU는 자신 내부에 있는 레지스터 외의 외부의 레지스터는 다 알고 있지 못한다. 장치 컨트롤러의 레지스터에 접근하는 방법엔 아래의 두 방법이 존재한다.
- **메모리 맵 입출력**
  - 메모리 맵 입출력은 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법이다.
  - 1024개의 주소 표현이 가능하다면, 512개는 메모리, 512개는 장치 컨트롤러 레지스터로 분할한다.
  - 메모리에 접근하는 명령어 그대로 입출력 명령어를 쓸 수 있다.
- **고립형 입출력**
  - 고립형 입출력은 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법이다.
  - 제어 버스에 메모리 읽기/쓰기 선과 입출력장치 읽기/쓰기 선이 있다면 1024개의 주소 공간을 각각 전부 할당해줄 수 있다.
  - 입출력장치에 접근할 땐 메모리에 접근하는 명령어와는 다른 입출력 명령어를 사용한다.

### 인터럽트 기반 입출력

- 입출력장치에 의한 하드웨어 인터럽트는 정확힌 장치 컨트롤러에 의해 발생한다.
- 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면, CPU는 하던 일을 백업하고 인터럽트 서비스 루틴을 실행한다.
- 컴퓨터는 키보드, 마우스, 모니터 등의 다양한 입출력 장치 인터럽트를 동시에 처리해야 한다.
- 단순히 인터럽트가 발생한 순서대로 인터럽트를 처리하는 방법도 있지만, 인터럽트 중에섣도 더 빨리 처리해야 하는 우선순위가 높은 인터럽트가 존재하므로 이는 적합하지 않다.
- 플래그 레지스터 속 인터럽트 비트가 활성화되어 있는 경우, 혹은 인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 **NMI**가 발생한 경우 CPU는 우선순위가 높은 인터럽트부터 처리한다.
- 우선순위를 반영하는 다중 인터럽트 처리 방법엔 여러 방법이 있으나 많은 컴퓨터가 **프로그래머블 인터럽트 컨트롤러**(PIC)라는 하드웨어를 사용한다.
  - PIC는 여러 장치 컨트롤러에 연결되어, 장치 컨트롤러가 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별해 CPU에게 처리해야 할 인터럽트를 알려주는 장치이다.
  - CPU가 PIC에 인터럽트 확인 신호를 보내면, PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보낸다.
  - NMI는 우선순위가 가장 높은 인터럽트이므로, PIC가 NMI까지 우선순위를 판별하지는 않는다.

### DMA 입출력

- 위 두 방법은 모두 메모리와 입출력장치 간의 데이터 이동을 CPU가 주도하고 담당한다.
- 가뜩이나 바쁜 CPU를 점유할 뿐더러, 대용량 데이터를 옮길 땐 CPU 부담이 더욱 커진다.
- **DMA**(Direct Memory Access)는 입출력장치와 메모리가 CPU를 거치지 않고도 상호작용할 수 있는 입출력 방식이다.
- DMA 입출력을 위해서는 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요하다.
- DMA 입출력 과정
  1. CPU는 DMA 컨트롤러에 입출력 장치의 주소, 연산, 읽고쓸 메모리 주소 등 정보로 입출력 작업을 명령한다.
  2. DMA는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.
  3. 입출력 작업이 끝나면 DMA는 CPU에게 인터럽트를 걸어 작업이 끝났음을 알립니다.
- CPU는 DMA에게 입출력 작업 명령을 내리고, 인터럽트만 받으면 되어 작업 부담이 훨씬 줄어든다.
- 그러나 DMA 컨트롤러는 시스템 버스로 메모리에 직접 접근하는데, 시스템 버스는 공용 자원이라 동시에 사용이 불가능하다. CPU가 시스템 버스를 사용할 땐 DMA 컨트롤러는 시스템 버스를 사용할 수 없고, 그 반대도 마찬가지이다. 그래서 DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 이용하거나, CPU에게 시스템 버스를 이용하지 않도록 허락을 구하고 사용한다.
- **입출력 버스**
  - DMA가 시스템 버스를 너무 자주 사용하면 그만큼 CPU가 시스템 버스를 이용하지 못하므로, 이 문제는 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결하여 해결할 수 있다.
  - 입출력 버스에는 **PCI 버스, PCI Express(PCle) 버스** 등이 존재한다. 또한 여러 입출력장치를 PCle 버스와 연결해주는 통로인 PCle 슬롯도 별도로 존재한다.
- DMA를 사용함에도 불구하고 일정 부분은 CPU의 몫인데, 최근에는 입출력장치 내부에 입출력 전용 CPU를 달아서 나오기도 한다. 이를 입출력 프로세서(IOP) 또는 입출력 채널(I/O Channel)이라고 한다.