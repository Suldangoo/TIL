# Chapter 12 : 프로세스 동기화

## 동기화란

### 동기화의 의미

- 동시다발적으로 실행되는 많은 프로세스는 서로 데이터를 주고받고 협력하며 실행될 수 있다.
- 이렇게 협력적으로 실행되는 프로세스는 마구 동시에 실행해선 안되고, **동기화**가 필수이다.
- **프로세스 동기화**란 프로세스들 사이의 수행 시기를 맞추는 것을 의미한다.
- 수행 시기를 맞추는 것은 크게 아래 두 가지를 일컫는다.
  1. 실행 순서 제어 : 프로세스를 올바른 순서대로 실행하기
  2. 상호 배제 : 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기
- 즉, 동기화는 특정 자원에 접근할 때 한 개의 프로세스만 접근하게 하거나, 올바른 순서대로 실행하게 하는 것을 의미한다.
- 동기화에는 실행 순서 제어를 위한 동기화와, 상호 배제를 위한 동기화가 있다.
- **실행 순서 제어를 위한 동기화**
  - 만약 reader 프로세스와 writer 프로세스가 동시에 실행된다면, 반드시 writer 프로세스가 먼저 실행되어 데이터가 쓰여져야 reader 프로세스를 실행할 수 있다.
  - 이런 경우를 위해 동시에 실행되는 프로세스를 올바른 순서대로 실행할 수 있어야 한다.
- **상호 배제를 위한 동기화**
  - 공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘이다.
  - 동기화가 제대로 이루어지지 않으면, 예를 들어 변수의 값에 영향을 주는 프로세스들이 여러 개 실행될 때 제대로 저장이 이루어지지 않을 수 있다.
  - 반드시 동시 사용이 불가능한 데이터를 사용할 때에는 해당 데이터를 사용하는 프로세스가 사용이 종료되어야 다음 프로세스가 접근하도록 해야 한다.

### 생산자와 소비자 문제

- 상호 배제를 위한 동기화 중 고전적이고 유명한 문제로 **생산자와 소비자 문제**가 있다.
- 이 문제는 물건을 계속해서 생산하는 프로세스인 생산자와, 물건을 계속해서 소비하는 프로세스인 소비자로 이루어져 있다.
- 총합이라는 변수에 10을 초기화하고, 이 프로세스들을 동시에 각각 100,000번 동시에 실행하면 10 그대로 있어야 할 것 같지만 실행 결과 매우 이상한 값이 나타난다.
- 이것은 프로세스가 제대로 동기화되지 않았기 때문에 발생한 문제이다.
- 생산자가 소비자의 작업이 끝나기도 전에 총합을 수정하고, 반대로 소비자도 생산자의 작업이 끝나기도 전에 총합을 수정하니 발생하는 문제이다.

### 공유 자원과 임계 구역

- 위의 총합 문제나 생산자와 소비자 문제 모두 **전역 변수**라는 공동 자원을 두고 작업했다.
- 이러한 자원을 **공유 자원**(Shared Resource)이라고 한다.
- 공유 자원은 전역 변수가 될 수도 있고, 파일이 될 수도 있고, 입출력장치나 보조기억장치가 될 수도 있다.
- 또한 동시에 실행하면 문제가 발생하는  자원에 접근하는 코드 영역을 **임계 구역**이라고 한다.
- A 프로세스가 한 자원을 차지할 때 임계 구역에 들어간다고 표현하고, 그 자원을 전부 사용했다면 임계 구역에서 나온다고 표현한다.
- 임계 구역은 동시에 두 개 이상의 프로세스가 접근하면 안 되는 영역이지만, 잘못된 실행으로 인해 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우를 **레이스 컨디션**이라고 한다.
- 레이스 컨디션이 발생하면 생산자와 소비자 문제처럼 데이터의 일관성이 깨지는 경우가 발생한다.
- 고급 언어로 한 줄만에 표현되는 명령이어도, 저급 언어로 변환되며 여러 줄로 표현될 수 있기 때문에 그 여러 줄을 실행하던 도중 문맥 교환이 일어나게 되면 문제가 발생하는 것이다.
- 운영 체제는 임계 구역 문제를 해결하기 위해, 즉 상호 배제를 위한 동기화를 위해 세 가지 원칙을 반드시 지킨다.
  1. 상호 배제 : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
  2. 진행 : 임계 구역에 어느 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 진입할 수 있어야 한다.
  3. 유한 대기 : 한 프로세스가 임계 구역에 진입하고 싶다면, 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다. 즉, 임계 구역에 들어가려고 무한정 대기해서는 안 된다.

## 동기화 기법

- 어떻게 해야 임계 구역에 오직 하나의 프로세스만 진입하게 하고, 올바른 실행 순서를 보장할 수 있을까?
- 이를 위한 것이 대표적인 동기화 도구인 뮤텍스 락, 세마포, 모니터이다.

### 뮤텍스 락

- 뮤텍스 락을 이해할 땐 1인용 탈의실을 생각하면 편하다.
- 탈의실 내부가 비어있는지(임계 구역을 프로세스가 사용중인지) 알려면, 자물쇠가 걸려있는지 확인하면 된다. 자물쇠가 걸려 있지 않다면 탈의실을 이용하면 된다.
- 이 자물쇠 기능을 코드로 구현한 것이 **뮤텍스 락**(Mutex Lock)이라는 상호 배제를 위한 동기화 도구이다.
- 매우 단순한 형태의 뮤텍스 락은 전역 변수 하나와 두 개의 함수로 구현할 수 있다.
  - 자물쇠 역할 : 프로세스들이 공유하는 전역 변수 look
  - 임계 구역을 잠그는 역할 : acquire 함수
  - 임계 구역 잠금을 해제하는 역할 : release 함수
- **acquire 함수**는 프로세스가 임계 구역에 진입하기 전에 호출하는 함수이다.
  - 만일 임계 구역이 잠겨있다면 열릴 때까지 (lock이 false가 될 때까지) 임계 구역을 반복적으로 확인하고, 열려있다면 잠그는 (lock을 true로 만드는) 함수이다.