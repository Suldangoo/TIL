# Chapter 04 : CPU의 작동 원리

## ALU와 제어장치
- CPU 내부에는 계산을 담당하는 ALU, 명령어를 읽고 해석하는 제어장치, 임시 저장 장치인 레지스터가 있다.
- 큰 개념은 Chapter 01 - 2에 있으므로 기억이 나지 않는다면 리마인드할 것.

### ALU
- ALU는 CPU 내에서 산술 연산과 논리 연산을 담당하는 부품이다.
- ALU는 레지스터를 통해 피연산자를 두 개 받아들이고, 제어장치로부터 수행할 연산을 알려주는 제어 신호를 받아들인다.
- 받아들인 피연산자와 제어 신호에 따라 다른데, 연산을 수행한 결과는 특정 숫자나 문자가 될 수도 있으며, 메모리 주소가 될 수도 있다.
- 이 결괏값은 바로 메모리에 저장되지 않으며 일시적으로 레지스터에 저장된다.
- 그 외에도 ALU는 계산 결과와 더불어 **플래그**를 내보닌다.
- **플래그**
  - 이진수만 보고선 음양수를 판단하기 어렵기 때문에, 음수와 양수를 판단하기 위해 플래그를 사용한다.
  - 즉, ALU는 결괏값뿐만 아니라 연산 결과에 대한 추가 정보를 내보내야 할 때가 있다.
  - 예를 들어 방금 계산 결과는 음수라던가, 결괏값이 레지스터보다 클 때 오버플로우가 났다는 등의 추가 정보가 플래그이다.
- **플래그의 종류**
  - 부호 플래그 : 연산한 결과의 부호를 나타낸다. (부호 플래그가 1일땐 음수, 0일땐 양수)
  - 제로 플래그 : 연산 결과가 0인지 여부를 나타낸다. (제로 플래그가 1일땐 0, 0일땐 0이 아님)
  - 캐리 플래그 : 연산 결과 올림수나 빌림수가 발생했는지를 나타낸다. (캐리 플래그가 1일땐 발생, 0일땐 발생하지 않음)
  - 오버플로우 플래그 : 오버플로우가 발생했는지를 나타낸다. (오버플로우 플래그가 1일땐 발생, 0일땐 발생하지 않음)
  - 인터럽트 플래그 : 인터럽트가 가능한지를 나타낸다. (인터럽트 플래그가 1일땐 가능함, 0일땐 가능하지 않음)
  - 슈퍼바이저 플래그 : 커널 모드인지, 사용자 모드인지를 나타낸다. (슈퍼바이저 플래그가 1일땐 커널 모드, 0일땐 사용자 모드로 실행중)
- 발생한 플래그는 **플래그 레지스터**라는 이름의 레지스터에 저장된다.
- 이 밖에도 ALU 내부에는 가산기, 보수기, 시프터, 오버플로우 검출기 등의 회로가 존재한다.
### 제어장치
- 제어장치는 제어 신호를 내보내고, 명령어를 해석하는 부품이다.
- 제어 신호는 컴퓨터 부품들을 관리하고 작동시키기 위한 일종의 전기 신호이다.
- 제어장치는 굉장히 정교하기 때문에, 받아들이고 내보내는 정보들이 굉장히 많다.
- **제어장치는 클럭 신호를 받아들인다.**
  - **클럭**이란 컴퓨터의 모든 부품들이 일정하게 움직일 수 있게 하는 시간 단위이다.
  - 하나의 명령어가 여러 클럭에 걸쳐 실행될 수도 있다.
- **제어장치는 해석해야 할 명령어를 받아들인다.**
  - CPU가 해석해야 할 명령어는 명령어 레지스터라는 특별한 레지스터에 저장된다.
  - 제어장치는 이 명령어 레지스터에서 해석할 명령어를 받아들이고 해석한 뒤, 제어 신호를 발생시켜 부품들에게 명령을 내린다.
- **제어장치는 플래그 레지스터 속 플래그 값을 받아들인다.**
  - 제어장치는 플래그 값을 받아들이고, 이를 참고하여 제어 신호를 발생시킨다.
- **제어장치는 시스템 버스, 그 중에서 제어 버스로 전달된 제어 신호를 받아들인다.**
  - 제어 신호는 CPU뿐만 아니라 입출력장치를 비롯한 외부 장치도 발생시킬 수 있다.
  - 제어장치는 제어 버스를 통해 외부로부터 전달된 제어 신호를 받아들이기도 한다.
- 제어장치가 내보내는 정보에는 크게 CPU 외부에 전달하는 제어 신호와, CPU 내부에 전달하는 제어 신호가 있다.
- CPU 외부에 제어 신호를 전달한다는 것은 곧 제어 버스로 제어 신호를 내보낸다는 것이다.
- 이러한 제어 신호에는 크게 메모리에 전달하는 제어 신호와 입출력장치에 전달하는 제어 신호가 있다.
- 메모리에 저장된 값을 읽거나 쓰고싶다면 메모리로, 입출력장치의 값을 읽거나 쓰고싶다면 입출력장치로 제어 신호를 내보낸다.
- CPU 내부에 전달하는 제어 신호는 크게 ALU에 전달하는 제어 신호와 레지스터에 전달하는 제어 신호가 있다.
- ALU에는 수행할 연산을 지시하기 위해, 레지스터에는 레지스터 간에 데이터를 이동시키거나 저장된 명령어를 해석하기 위해 제어 신호를 내보낸다.

## 레지스터
- 프로그램 속 명령어와 데이터는 실행 전후로 반드시 레지스터에 저장된다.
- 레지스터만 잘 관찰해도 프로그램의 자세한 실행 과정과 CPU 내의 일들을 모두 알 수 있다.

### 반드시 알아야 할 레지스터
- 상용화된 CPU 속 레지스터는 굉장히 종류가 많으며 이름과 크기도 제각각이나, 많은 CPU에서 공통으로 포함하는 레지스터가 있다.

1. **프로그램 카운터 (PC;Program Counter)**
   - 메모리에서 가져올 명령어의 주소, 즉 메모리에서 읽어 들일 명령어의 주소를 저장한다.
   - 명령어 포인터라고 부르기도 한다.
   - 지속적으로 1씩 증가하며 다음 명령어를 읽을 준비를 하는 레지스터이다.
     - 물론 JUMP 2500과 같은 특정 메모리 주소로 실행 흐름을 이동하는 명령어가 실행되면 1씩 증가되지 않고 바로 이동한다.
2. **명령어 레지스터 (IR;Instruction Register)**
   - 해석할 명령어를 저장하는 레지스터이다.
3. **메모리 주소 레지스터 (MAR;Memory Address Register)**
   - 메모리의 주소를 저장하는 레지스터이다.
   - CPU가 읽어 들이고자 하는 주소 값을 주소 버스로 보낼 때, 메모리 주소 레지스터를 거친다.
4. **메모리 버퍼 레지스터 (MBR;Memory Buffer Register)**
   - 메모리와 주고받을 값(데이터와 명령어)을 저장하는 레지스터이다.
   - 메모리에 쓰고 싶은 값이나, 메모리로부터 전달받은 값은 메모리 버퍼 레지스터를 거친다.
   - CPU가 데이터 버스로 주고받을 값은 메모리 버퍼 레지스터를 거친다.
5. **범용 레지스터 (General Purpose Register)**
   - 다양하고 일반적인 상황에서 자유롭게 사용할 수 있는 레지스터이다.
   - 데이터와 주소를 모두 저장할 수 있으며, 일반적으로 CPU 내부엔 여러 개의 범용 레지스터들이 있다.
6. **플래그 레지스터**
   - ALU 연산 결과에 따른 플래그를 저장하는 레지스터이다.
   - 연산 결과 또는 CPU 상태에 대한 부가적인 정보를 저장하는 레지스터이다.
7. **스택 포인터와 베이스 레지스터**
   - 스택 주소 지정 방식과 변위 주소 지정 방식이라는 특별한 주소 지정 방식에 사용되는 레지스터이다.

